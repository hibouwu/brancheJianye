# Android 插件项目完整说明文档

## 项目概述

本项目包含三个相关的子项目：VersionPlugin、plugin-project 和 PluginManager。这些项目共同构成了一个完整的 Android 插件化解决方案。

## 项目结构

### 1. VersionPlugin（版本插件）

```
VersionPlugin/
├── app/                    # 主应用模块
│   ├── src/
│   │   ├── main/
│   │   │   ├── java/              # Java 源代码目录
│   │   │   │   └── descartes/
│   │   │   │       └── info/
│   │   │   │           └── l3p2/
│   │   │   │               ├── MainActivity.java          # 主活动类
│   │   │   │               ├── FixedPathPmUpdater.java    # 插件更新器
│   │   │   │               ├── base/
│   │   │   │               │   └── MyApplication.java     # 应用基类
│   │   │   │               ├── utils/
│   │   │   │               │   └── AndroidLoggerFactory.java  # 日志工厂
│   │   │   │               └── service/
│   │   │   │                   └── MainPluginProcessService.java  # 插件进程服务
│   │   │   ├── res/              # 资源文件目录
│   │   │   │   ├── layout/       # 布局文件
│   │   │   │   ├── values/       # 值资源
│   │   │   │   ├── drawable/     # 图片资源
│   │   │   │   ├── mipmap-*/     # 应用图标
│   │   │   │   └── xml/          # XML 配置文件
│   │   │   └── AndroidManifest.xml
│   └── build.gradle
├── build.gradle           # 项目级构建配置
├── gradle.properties      # Gradle 属性配置
├── settings.gradle        # 项目设置
└── gradlew               # Gradle 包装器脚本
```

#### 主要类详细说明

1. **MainActivity.java**
   - 位置：`descartes.info.l3p2`
   - 功能：主活动类，负责插件启动和界面交互
   - 详细说明：
     - 继承自 `AppCompatActivity`
     - 主要职责：
       - 初始化界面布局
       - 处理插件启动逻辑
       - 管理插件生命周期
     - 关键方法：
       - `onCreate()`: 初始化界面，设置布局
       - `startPlugin(View view)`: 
         - 创建插件启动参数 Bundle
         - 配置插件路径和参数
         - 设置插件入口类名
         - 处理插件启动回调
     - 重要属性：
       - `pluginPath`: 插件文件路径
       - `partKey`: 插件标识符
       - `activityClassName`: 插件入口类名

2. **FixedPathPmUpdater.java**
   - 位置：`descartes.info.l3p2`
   - 功能：实现插件管理器更新器接口
   - 详细说明：
     - 实现 `PluginManagerUpdater` 接口
     - 主要职责：
       - 管理插件更新状态
       - 处理插件文件更新
       - 提供最新插件版本
     - 关键方法：
       - `wasUpdating()`: 检查更新状态
       - `update()`: 执行更新操作
       - `getLatest()`: 获取最新版本
       - `isAvailable()`: 检查版本可用性
     - 重要属性：
       - `apk`: 插件文件对象

3. **MyApplication.java**
   - 位置：`descartes.info.l3p2.base`
   - 功能：应用程序基类，管理插件管理器实例
   - 详细说明：
     - 继承自 `Application`
     - 主要职责：
       - 初始化插件管理器
       - 管理插件进程
       - 处理插件运行时环境
     - 关键方法：
       - `onCreate()`: 
         - 初始化日志系统
         - 检查进程类型
         - 初始化插件管理器
       - `getPluginManager()`: 获取插件管理器实例
       - `isProcess()`: 检查当前进程类型
     - 重要属性：
       - `sPluginManager`: 静态插件管理器实例
       - `PlUGIN_MANAGER_APK_FILE_PATH`: 插件管理器 APK 路径

### 2. plugin-project（插件项目）

```
plugin-project/
├── app/                    # 主应用模块
│   ├── src/
│   │   ├── main/
│   │   │   ├── java/              # Java 源代码
│   │   │   │   └── descartes/
│   │   │   │       └── info/
│   │   │   │           └── l3p2/
│   │   │   │               └── eyetrek/  # 具体实现类
│   │   │   │                   ├── rechercheEncyclopedie/  # 百科全书搜索模块
│   │   │   │                   │   ├── services/          # 服务类
│   │   │   │                   │   ├── interfaces/        # 接口定义
│   │   │   │                   │   └── adapters/          # 适配器类
│   │   │   │                   ├── reconnaissanceArbres/   # 树木识别模块
│   │   │   │                   │   ├── activity/          # 活动类
│   │   │   │                   │   ├── services/          # 服务类
│   │   │   │                   │   ├── fragments/         # 碎片类
│   │   │   │                   │   ├── classes/           # 工具类
│   │   │   │                   │   └── adapters/          # 适配器类
│   │   │   │                   └── modularite/            # 模块化相关
│   │   │   ├── aidl/              # AIDL 接口定义
│   │   │   ├── res/               # 资源文件
│   │   │   ├── assets/            # 资源文件
│   │   │   ├── libs/              # 库文件
│   │   │   ├── signed/            # 签名文件
│   │   │   ├── signedv2/          # V2 签名文件
│   │   │   └── release/           # 发布配置
│   └── build.gradle
├── sample-runtime/         # 运行时示例模块
│   ├── src/
│   │   └── main/
│   │       ├── java/              # Java 源代码
│   │       │   └── com/
│   │       │       └── tencent/
│   │       │           └── shadow/
│   │       │               └── sample/
│   │       │                   └── runtime/  # 运行时实现类
│   │       │                       ├── PluginDefaultProxyActivity.java
│   │       │                       ├── PluginSingleInstance1ProxyActivity.java
│   │       │                       └── PluginSingleTask1ProxyActivity.java
│   │       └── AndroidManifest.xml
│   └── build.gradle
├── sample-loader/          # 加载器示例模块
│   ├── src/
│   │   └── main/
│   │       ├── java/              # Java 源代码
│   │       │   └── com/
│   │       │       └── tencent/
│   │       │           └── shadow/
│   │       │               └── sample/
│   │       │                   └── loader/   # 加载器实现类
│   │       │                       ├── SampleComponentManager.java
│   │       │                       └── SamplePluginLoader.java
│   │       └── AndroidManifest.xml
│   └── build.gradle
├── transform-kit/          # 转换工具包
│   ├── src/
│   │   └── main/
│   │       ├── java/              # Java 源代码
│   │       │   └── com/
│   │       │       └── tencent/
│   │       │           └── shadow/
│   │       │               └── transform/    # 转换工具实现类
│   │       └── resources/         # 资源文件
│   └── build.gradle
├── build.gradle           # 项目级构建配置
├── gradle.properties      # Gradle 属性配置
└── README.md              # 项目说明文档
```

#### 主要模块详细说明

1. **app 模块**
   - 位置：`plugin-project/app`
   - 功能：主应用模块，包含插件宿主功能
   - 详细说明：
     - 包含插件宿主应用
     - 提供插件运行环境
     - 管理插件生命周期
     - 处理插件间通信

2. **sample-runtime 模块**
   - 位置：`plugin-project/sample-runtime`
   - 功能：运行时示例模块
   - 详细说明：
     - 提供插件运行环境
     - 实现插件隔离机制
     - 处理资源加载
     - 管理插件类加载器

3. **sample-loader 模块**
   - 位置：`plugin-project/sample-loader`
   - 功能：加载器示例模块
   - 详细说明：
     - 实现插件加载机制
     - 处理插件依赖
     - 管理插件版本
     - 提供插件更新功能

4. **transform-kit 模块**
   - 位置：`plugin-project/transform-kit`
   - 功能：转换工具包
   - 详细说明：
     - 提供代码转换功能
     - 实现字节码修改
     - 处理资源转换
     - 支持插件优化

### 3. PluginManager（插件管理器）

```
PluginManager/
├── app/                    # 主应用模块
│   ├── src/
│   │   ├── main/
│   │   │   ├── java/              # Java 源代码目录
│   │   │   │   ├── com/
│   │   │   │   │   └── tencent/
│   │   │   │   │       └── shadow/
│   │   │   │   │           └── dynamic/
│   │   │   │   │               └── host/
│   │   │   │   │                   ├── PluginManager.java      # 插件管理器
│   │   │   │   │                   ├── EnterCallback.java      # 进入回调
│   │   │   │   │                   ├── DynamicPluginManager.java  # 动态插件管理器
│   │   │   │   │                   └── DynamicRuntime.java     # 动态运行时
│   │   │   │   └── descartes/
│   │   │   │       └── info/
│   │   │   │           └── l3p2/
│   │   │   │               └── manager/     # 管理器实现类
│   │   │   ├── res/              # 资源文件目录
│   │   │   │   ├── layout/       # 布局文件
│   │   │   │   ├── values/       # 值资源
│   │   │   │   └── drawable/     # 图片资源
│   │   │   └── AndroidManifest.xml
│   └── build.gradle
├── build.gradle           # 项目级构建配置
├── gradle.properties      # Gradle 属性配置
└── settings.gradle        # 项目设置
```

#### 主要类详细说明

1. **PluginManager 相关类**
   - 位置：`com.tencent.shadow.dynamic.host`
   - 功能：管理插件的加载、运行和生命周期
   - 详细说明：
     - 核心接口和实现类
     - 主要职责：
       - 加载插件
       - 管理插件生命周期
       - 处理插件间通信
       - 提供插件运行环境
     - 关键方法：
       - `loadPlugin()`: 加载插件
       - `startPlugin()`: 启动插件
       - `stopPlugin()`: 停止插件
       - `getPluginInfo()`: 获取插件信息

2. **EnterCallback 接口**
   - 位置：`com.tencent.shadow.dynamic.host`
   - 功能：定义插件进入时的回调方法
   - 详细说明：
     - 回调接口定义
     - 主要职责：
       - 处理插件加载状态
       - 管理加载界面
       - 通知加载完成
     - 关键方法：
       - `onShowLoadingView()`: 显示加载视图
       - `onCloseLoadingView()`: 关闭加载视图
       - `onEnterComplete()`: 插件进入完成

## 类之间的关系

1. **插件加载流程**
   ```
   MainActivity -> PluginManager -> EnterCallback -> 插件实例
   ```

2. **更新流程**
   ```
   FixedPathPmUpdater -> PluginManager -> 插件更新
   ```

## 运行说明

### 环境要求
- Android Studio
- JDK 8 或更高版本
- Gradle 7.0 或更高版本

### 构建和运行步骤

1. **VersionPlugin**:
   ```bash
   cd VersionPlugin
   ./gradlew build
   ```

2. **plugin-project**:
   ```bash
   cd plugin-project
   ./gradlew build
   ```
   - 运行示例应用：在 Android Studio 中打开项目，选择 `app` 模块运行
   - 运行示例加载器：选择 `sample-loader` 模块运行

3. **PluginManager**:
   ```bash
   cd PluginManager
   ./gradlew build
   ```
   - 在 Android Studio 中打开项目并运行 `app` 模块

### 使用说明

#### 插件启动流程

1. 在 `MainActivity` 中调用 `startPlugin` 方法
2. 配置插件路径和参数
3. 通过 `PluginManager` 进入插件
4. 处理回调事件

#### 插件更新流程

1. 创建 `FixedPathPmUpdater` 实例
2. 检查更新状态
3. 执行更新操作
4. 获取最新版本

## 注意事项

1. 插件路径配置
   - 确保插件文件路径正确
   - 检查文件权限

2. 回调处理
   - 正确处理所有回调方法
   - 注意线程安全问题

3. 版本兼容性
   - 确保插件版本与宿主兼容
   - 处理版本更新逻辑

4. 首次运行前请确保已配置好 `local.properties` 文件，指定正确的 Android SDK 路径
5. 如果遇到构建错误，请先尝试 "File -> Invalidate Caches / Restart"
6. 确保所有依赖项都已正确同步

## 开发建议

1. 插件开发
   - 遵循插件开发规范
   - 注意资源隔离

2. 性能优化
   - 优化插件加载时间
   - 减少内存占用

3. 错误处理
   - 完善错误处理机制
   - 提供友好的错误提示

## 开发流程

1. 克隆项目后，首先在 Android Studio 中打开需要开发的子项目
2. 等待 Gradle 同步完成
3. 根据需要修改相应模块的代码
4. 使用 Gradle 命令或 Android Studio 的构建功能进行构建
5. 运行相应的模块进行测试

## 常见问题

1. Gradle 同步失败
   - 检查 Internet 连接
   - 检查 Gradle 版本兼容性
   - 检查 `local.properties` 配置

2. 构建错误
   - 检查 JDK 版本配置
   - 检查 Android SDK 版本
   - 查看具体错误信息进行针对性解决

## 联系方式

如有问题，请通过以下方式联系：
- 提交 Issue
- 发送 Pull Request

## 许可证

请参考各个项目中的 LICENSE 文件了解具体的许可证信息。 